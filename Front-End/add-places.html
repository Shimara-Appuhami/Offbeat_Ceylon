<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Places</title>
    <link rel="stylesheet" href="css/add-places.css">
    <link rel="stylesheet" href="https://unpkg.com/ionicons@5.5.2/dist/css/ionicons.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFpFDLrN4DPjDEXp7kKfGuooEL5tSheCk" async defer></script>
</head>
<body>

<form id="addPlaceForm">

    <div class="segment">
        <h1>Add New Place</h1>
    </div>

    <label>
        <input type="text" placeholder="Place Name" required id="placeName" name="placeName" />
    </label>

    <label>
        <input type="text" placeholder="About Place" id="aboutPlace" name="aboutPlace" />
    </label>

    <label>
        <select required id="district" name="district">
            <option value="" disabled selected>Select District </option>
            <option value="Colombo">Colombo</option>
            <option value="Gampaha">Gampaha</option>
            <option value="Kalutara">Kalutara</option>
            <option value="Kandy">Kandy</option>
            <option value="Matale">Matale</option>
            <option value="Nuwara Eliya">Nuwara Eliya</option>
            <option value="Galle">Galle</option>
            <option value="Matara">Matara</option>
            <option value="Hambantota">Hambantota</option>
            <option value="Jaffna">Jaffna</option>
            <option value="Kilinochchi">Kilinochchi</option>
            <option value="Mannar">Mannar</option>
            <option value="Vavuniya">Vavuniya</option>
            <option value="Mullaitivu">Mullaitivu</option>
            <option value="Batticaloa">Batticaloa</option>
            <option value="Ampara">Ampara</option>
            <option value="Trincomalee">Trincomalee</option>
            <option value="Kurunegala">Kurunegala</option>
            <option value="Puttalam">Puttalam</option>
            <option value="Anuradhapura">Anuradhapura</option>
            <option value="Polonnaruwa">Polonnaruwa</option>
            <option value="Badulla">Badulla</option>
            <option value="Monaragala">Monaragala</option>
            <option value="Ratnapura">Ratnapura</option>
            <option value="Kegalle">Kegalle</option>
        </select>
    </label>

    <label>
        <input type="file" accept="image/*" multiple required id="images" name="images" />
    </label>

    <div class="segment">
        <h2>Is this place dangerous?</h2>
        <div class="input-group">
            <label>
                <input type="radio" name="status" value="dangerous" required />
                <span class="radio-label">Dangerous</span>
            </label>
        </div>
        <div class="input-group">
            <label>
                <input type="radio" name="status" value="not-dangerous" required />
                <span class="radio-label">Not Dangerous</span>
            </label>
        </div>
    </div>

    <!-- Map Section -->
    <h3>Click on the map to select a location</h3>

<!--location search bar-->
    <input type="text" id="locationSearch" placeholder="Search for a location" />

    <div id="mapContainer"></div>
    <p id="coordinates" style="color: green; font-weight: bold;"></p>
    <div id="map" style="height: 400px; width: 100%;"></div>

    <button type="submit" class="submit-btn">Add Place</button>

</form>

<script src="js/jquery-3.7.1.min.js"></script>

<script>

        let selectedLat = null;
        let selectedLng = null;
        let map;
        let marker = null;

        function initMap() {
        const initialPosition = {lat: 7.8731, lng: 80.7718}; // Sri Lanka center

        map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: initialPosition,
    });

        map.addListener("click", (event) => {
        selectedLat = event.latLng.lat();
        selectedLng = event.latLng.lng();

        document.getElementById("coordinates").innerText =
        "Latitude: " + selectedLat + ", Longitude: " + selectedLng;

        if (marker) {
        marker.setPosition(event.latLng);
    } else {
        marker = new google.maps.Marker({
        position: event.latLng,
        map: map,
    });
    }
    });

        const savedPlaces = JSON.parse(localStorage.getItem("savedPlaces")) || [];
        if (savedPlaces.length > 0) {
        const savedPlace = savedPlaces[0];
        const savedPosition = {lat: savedPlace.latitude, lng: savedPlace.longitude};
        map.setCenter(savedPosition);
        map.setZoom(15);
        marker = new google.maps.Marker({
        position: savedPosition,
        map: map,
    });
        selectedLat = savedPlace.latitude;
        selectedLng = savedPlace.longitude;
        document.getElementById("coordinates").innerText =
        "Latitude: " + selectedLat + ", Longitude: " + selectedLng;
    }
    }

        window.onload = initMap;

        $("#locationSearch").on("input", function () {
        const searchInput = $(this).val();
        if (!searchInput) return;

        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({address: searchInput}, function (results, status) {
        if (status === "OK" && results[0]) {
        const location = results[0].geometry.location;
        selectedLat = location.lat();
        selectedLng = location.lng();

        map.setCenter(location);
        map.setZoom(15);

        if (marker) {
        marker.setPosition(location);
    } else {
        marker = new google.maps.Marker({
        position: location,
        map: map,
    });
    }

        document.getElementById("coordinates").innerText =
        "Latitude: " + selectedLat + ", Longitude: " + selectedLng;
    } else {
        console.warn("Geocode was not successful for the following reason: " + status);
    }
    });
    });

        $("#addPlaceForm").on("submit", function (e) {
        e.preventDefault();

        if (!selectedLat || !selectedLng) {
        alert("Please select a location on the map!");
        return;
    }

        const placeName = $("#placeName").val();
        const aboutPlace = $("#aboutPlace").val();
        const district = $("#district").val();
        const status = $('input[name="status"]:checked').val();
        const images = $("#images")[0].files;

        const formData = new FormData();
        formData.append('placeName', placeName);
        formData.append('aboutPlace', aboutPlace);
        formData.append('district', district);
        formData.append('status', status);
        formData.append('latitude', selectedLat);
        formData.append('longitude', selectedLng);

        for (let i = 0; i < images.length; i++) {
        formData.append('images', images[i]);
    }

        $.ajax({
        url: 'http://localhost:8081/api/v1/addPlace/save',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function (response) {
        alert('Place added successfully!');
        $("#addPlaceForm")[0].reset();
        $("#coordinates").text("");
        localStorage.removeItem("savedPlaces");
        window.location.href = "index.html";
    },
        error: function (xhr, status, error) {
        console.error('Error:', error);
        alert('Failed to add place!');
    }
    });
    });

        window.addEventListener("beforeunload", function () {
        if (selectedLat && selectedLng) {
        const currentPlace = {latitude: selectedLat, longitude: selectedLng};
        localStorage.setItem("savedPlaces", JSON.stringify([currentPlace]));
    }
    });
</script>
</body>
</html>
