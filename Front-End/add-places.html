<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Places</title>
    <link rel="stylesheet" href="css/add-places.css">
    <link rel="stylesheet" href="https://unpkg.com/ionicons@5.5.2/dist/css/ionicons.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFpFDLrN4DPjDEXp7kKfGuooEL5tSheCk" async defer></script>
</head>
<body>

<form id="addPlaceForm">

    <div class="segment">
        <h1>Add New Place</h1>
    </div>

    <label>
        <input type="text" placeholder="Place Name" required id="placeName" name="placeName" />
    </label>
    <label>
        <select id="category" name="category">
            <option value="" disabled selected>Select Category </option>
            <option value="hidden">Hidden & Unexplored Places</option>
            <option value="kingdom">Kingdom</option>
            <option value="waterfall">Waterfall</option>
            <option value="mountain">Mountain</option>
            <option value="temple">Temple</option>
            <option value="church">Church</option>
            <option value="lake">Lake</option>
            <option value="cave">Cave</option>
            <option value="island">Island</option>
            <option value="adventure">Adventure</option>
            <option value="lighthouse">Lighthouse</option>
            <option value="teaEstate">Tea Estate</option>
            <option value="beach">Beach</option>
            <option value="forest">Forest</option>
            <option value="museum">Museum</option>
            <option value="park">Park</option>
            <option value="zoo">Zoo</option>
            <option value="hospital">Hospital</option>
            <option value="park">Park</option>
            <option value="beach">Beach</option>

        </select>
    </label>

    <label>
        <input type="text" placeholder="About Place" id="aboutPlace" name="aboutPlace" />
    </label>

    <label>
        <select required id="district" name="district">
            <option value="" disabled selected>Select District </option>
            <option value="Colombo">Colombo</option>
            <option value="Gampaha">Gampaha</option>
            <option value="Kalutara">Kalutara</option>
            <option value="Kandy">Kandy</option>
            <option value="Matale">Matale</option>
            <option value="Nuwara Eliya">Nuwara Eliya</option>
            <option value="Galle">Galle</option>
            <option value="Matara">Matara</option>
            <option value="Hambantota">Hambantota</option>
            <option value="Jaffna">Jaffna</option>
            <option value="Kilinochchi">Kilinochchi</option>
            <option value="Mannar">Mannar</option>
            <option value="Vavuniya">Vavuniya</option>
            <option value="Mullaitivu">Mullaitivu</option>
            <option value="Batticaloa">Batticaloa</option>
            <option value="Ampara">Ampara</option>
            <option value="Trincomalee">Trincomalee</option>
            <option value="Kurunegala">Kurunegala</option>
            <option value="Puttalam">Puttalam</option>
            <option value="Anuradhapura">Anuradhapura</option>
            <option value="Polonnaruwa">Polonnaruwa</option>
            <option value="Badulla">Badulla</option>
            <option value="Monaragala">Monaragala</option>
            <option value="Ratnapura">Ratnapura</option>
            <option value="Kegalle">Kegalle</option>
        </select>
    </label>

    <label>
        <input type="file" accept="image/*" multiple required id="images" name="images" />
    </label>

    <div class="segment">
        <h2>Is this place dangerous?</h2>
        <div class="input-group">
            <label>
                <input type="radio" name="status" value="dangerous" required />
                <span class="radio-label">Dangerous</span>
            </label>
        </div>
        <div class="input-group">
            <label>
                <input type="radio" name="status" value="not-dangerous" required />
                <span class="radio-label">Not Dangerous</span>
            </label>
        </div>
    </div>

    <!-- map Section -->
    <h3>Click on the map to select a location</h3>

<!--location search bar-->
    <input type="text" id="locationSearch" placeholder="Search for a location" />

    <div id="mapContainer"></div>
    <p id="coordinates" style="color: green; font-weight: bold;"></p>
    <div id="map" style="height: 400px; width: 100%;"></div>

    <button type="submit" class="submit-btn">Add Place</button>
    <button type="button" class="submit-btn" id="btn-update-place">update</button>
    <button type="button" class="submit-btn" onclick="deletePlace()">delete</button>

</form>

<script src="js/jquery-3.7.1.min.js"></script>

<script>
    const token=localStorage.getItem('token');


    let selectedLat = null;
        let selectedLng = null;
        let map;
        let marker = null;

        function initMap() {
        const initialPosition = {lat: 7.8731, lng: 80.7718};

        map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: initialPosition,
    });

        map.addListener("click", (event) => {
        selectedLat = event.latLng.lat();
        selectedLng = event.latLng.lng();

        document.getElementById("coordinates").innerText =
        "Latitude: " + selectedLat + ", Longitude: " + selectedLng;

        if (marker) {
        marker.setPosition(event.latLng);
    } else {
        marker = new google.maps.Marker({
        position: event.latLng,
        map: map,
    });
    }
    });

        const savedPlaces = JSON.parse(localStorage.getItem("savedPlaces")) || [];
        if (savedPlaces.length > 0) {
        const savedPlace = savedPlaces[0];
        const savedPosition = {lat: savedPlace.latitude, lng: savedPlace.longitude};
        map.setCenter(savedPosition);
        map.setZoom(15);
        marker = new google.maps.Marker({
        position: savedPosition,
        map: map,
    });
        selectedLat = savedPlace.latitude;
        selectedLng = savedPlace.longitude;
        document.getElementById("coordinates").innerText =
        "Latitude: " + selectedLat + ", Longitude: " + selectedLng;
    }
    }

        window.onload = initMap;

        $("#locationSearch").on("input", function () {
        const searchInput = $(this).val();
        if (!searchInput) return;

        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({address: searchInput}, function (results, status) {
        if (status === "OK" && results[0]) {
        const location = results[0].geometry.location;
        selectedLat = location.lat();
        selectedLng = location.lng();

        map.setCenter(location);
        map.setZoom(15);

        if (marker) {
        marker.setPosition(location);
    } else {
        marker = new google.maps.Marker({
        position: location,
        map: map,
    });
    }

        document.getElementById("coordinates").innerText =
        "Latitude: " + selectedLat + ", Longitude: " + selectedLng;
    } else {
        console.warn("Geocode was not successful for the following reason: " + status);
    }
    });
    });

        $("#addPlaceForm").on("submit", function (e) {
        e.preventDefault();

        if (!selectedLat || !selectedLng) {
        alert("Please select a location on the map!");
        return;
    }

        const placeName = $("#placeName").val();
        const aboutPlace = $("#aboutPlace").val();
        const district = $("#district").val();
        const status = $('input[name="status"]:checked').val();
        const images = $("#images")[0].files;
        const category=$("#category").val();

        const formData = new FormData();
        formData.append('placeName', placeName);
        formData.append('aboutPlace', aboutPlace);
        formData.append('district', district);
        formData.append('status', status);
        formData.append('latitude', selectedLat);
        formData.append('longitude', selectedLng);
        formData.append('category', category);

        for (let i = 0; i < images.length; i++) {
        formData.append('images', images[i]);
    }
        $.ajax({
        url: 'http://localhost:8081/api/v1/addPlace/save',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
            headers: {
                "Authorization": "Bearer " + localStorage.getItem('token')
            },
        success: function (response) {

            console.log("Response received:", response);
            console.log("token"+token);

        alert('Place added successfully!');
        $("#addPlaceForm")[0].reset();
        $("#coordinates").text("");
        // localStorage.removeItem("savedPlaces");
        // window.location.href = "index.html";
    },
        error: function (xhr, status, error) {
        console.error('Error:', error);
        alert('Failed to add place!');
    }
    });
    });

        window.addEventListener("beforeunload", function () {
        if (selectedLat && selectedLng) {
        const currentPlace = {latitude: selectedLat, longitude: selectedLng};
        localStorage.setItem("savedPlaces", JSON.stringify([currentPlace]));
    }
    });

    let placeId = null;

   //search
    $("#placeName").on("keypress", function (event) {
        if (event.which === 13) {
            event.preventDefault();
            const placeName = $(this).val().trim();

            if (placeName) {
                $.ajax({
                    url: `http://localhost:8081/api/v1/addPlace/getAllByName/${placeName}`,
                    type: "GET",
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem('token')
                    },
                    success: function (response) {
                        console.log("Response received:", response);

                        if (response && response.placeId) {
                            placeId = response.placeId;

                            $("#category").val(response.category);
                            $("#aboutPlace").val(response.aboutPlace);
                            $("#district").val(response.district);
                            $("input[name='status'][value='" + response.status + "']").prop("checked", true);

                            if (response.latitude && response.longitude) {
                                selectedLat = response.latitude;
                                selectedLng = response.longitude;

                                map.setCenter({ lat: selectedLat, lng: selectedLng });
                                map.setZoom(15);

                                if (marker) {
                                    marker.setPosition({ lat: selectedLat, lng: selectedLng });
                                } else {
                                    marker = new google.maps.Marker({
                                        position: { lat: selectedLat, lng: selectedLng },
                                        map: map,
                                    });
                                }

                                $("#coordinates").text(`Latitude: ${selectedLat}, Longitude: ${selectedLng}`);
                            }

                            if (response.imageUrl) {
                                $("#images").attr("src", response.imageUrl).show();
                            } else {
                                $("#images").hide();
                            }
                        } else {
                            alert("Place not found or placeId is missing!");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching place:", error);
                        alert("Error fetching place details!");
                    }
                });
            }
        }
    });

    $("#btn-update-place").on("click", function () {
        if (placeId === null) {
            alert("Please search for a place first!");
            console.warn("Update attempt failed: placeId is null.");
            return;
        }

        const formData = new FormData();
        formData.append("placeName", $("#placeName").val().trim());
        formData.append("category", $("#category").val());
        formData.append("aboutPlace", $("#aboutPlace").val().trim());
        formData.append("district", $("#district").val());
        formData.append("status", $("input[name='status']:checked").val());
        formData.append("latitude", selectedLat);
        formData.append("longitude", selectedLng);

        const imageInput = $("#imageUpload")[0];
        if (imageInput && imageInput.files.length > 0) {
            formData.append("image", imageInput.files[0]);
        }

        $.ajax({
            url: `http://localhost:8081/api/v1/addPlace/update/${placeId}`,
            type: "PUT",
            headers: {
                "Authorization": "Bearer " + localStorage.getItem('token')
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("Place updated successfully!");
                console.log("Update Response:", response);
            },
            error: function (xhr, status, error) {
                console.error("Error updating place:", error);
                alert("Error updating place details!");
            }
        });
    });

    //delete
    function deletePlace(placeId) {
        if (confirm("Are you sure you want to delete this place?")) {
            $.ajax({
                url: `http://localhost:8081/api/v1/addPlace/delete/${placeId}`,
                type: "DELETE",
                headers: {
                    "Authorization": "Bearer " + localStorage.getItem('token')
                },
                success: function (response) {
                    alert("Place deleted successfully!");
                    window.location.reload();
                },
                error: function (xhr, status, error) {
                    alert("Failed to delete place.");
                    console.error("Error:", error);
                }
            });
        }
    }



</script>
</body>
</html>
